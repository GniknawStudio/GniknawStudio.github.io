function readJSONFileSync(path) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', path, false); // Make the request synchronous by passing false as the third parameter
    xhr.send();

    if (xhr.status === 200) {
        return JSON.parse(xhr.responseText); // Return parsed JSON data if request is successful
    } else {
        console.error('Error fetching JSON file:', xhr.status);
        return null; // Return null on error
    }
}

function prepareForm() {

    var search_engine = readJSONFileSync("/pentest-tools/static/identity.json");
    var keys = Object.keys(search_engine);
    var selectContainer = document.querySelector("#select-container");
    var inputSection = document.querySelector("#input-section");
    var submitButton = document.querySelector("#search-button");
    
    // Display list of search engine
    keys.forEach(key => {
        selectContainer.innerHTML += `<option value="${key}">${search_engine[key]["name"]}</option>`;
    });

    selectContainer.addEventListener("change",() => {
        var searchEngine = search_engine[selectContainer.value];
        var inputElement = document.querySelectorAll(".input-param");
        if(searchEngine){
            var handleSubmit = function prepareURL(){
                var inputField = document.querySelectorAll(".input-param");
                var totalParams = searchEngine["parameters"].length;
                var query = "";
                var url = searchEngine["url"] + "?";
                    if (searchEngine["filter"] === "None") {
                        for (let i = 0; i < totalParams; i++) {
                            query += (searchEngine["parameters"][i] + "=" + inputField[i].value + "&");
                        }
                    } else {
                        for (let i = 0; i < totalParams; i++) {
                            query += (searchEngine["parameters"][i] + "=" + searchEngine["filter"] + "" + '"' + inputField[i].value + '"' + "&");
                        }
                    }

                window.open(url + query,"_blank");
            }

            submitButton.onclick = handleSubmit;
            var temp = "";
            if(inputElement.length === 1){
                temp = inputElement[0].value;
            }

            inputSection.innerHTML = "";
            if (searchEngine) {
                var totalElements = searchEngine["form_elements"].length;
                for (let i = 0; i < totalElements; i++) {
                    inputSection.innerHTML += searchEngine["form_elements"][i];
                }
                if(totalElements.length === 1){
                    document.querySelectorAll(".input-param")[0].value = temp;
                }
            }
            
            inputElement = document.querySelectorAll(".input-param");
            inputElement.forEach(element => {
                element.addEventListener("keypress", function(event) {
                    if (event.keyCode === 13) {
                        event.preventDefault();
                        submitButton.click(); // Trigger form submission when Enter key is pressed
                    }
                });
            })
        }
    });
    
}

